<h1>Effective SSH usage for Pentesters</h1>
<p>This is a beginner level session to train you into using <code>SSH</code> more effectively.</p>
<p>While pentesters may benefit (especially if they are planning on doing a time based exam like OSCP), this should be useful for anyone who has a need to login to servers using a <code>Secure SHell</code>.</p>
<blockquote>
<p>OpenSSH is an opensource implmentation of the SSH protocol</p>
</blockquote>
<h2>Getting Started</h2>
<h3>Login to the server</h3>
<p>You need the following four things</p>
<ol>
<li>SSH Client software</li>
<li>Username that you are trying to login as</li>
<li>Hostname/IP address of that server</li>
<li>Password of the username you are trying to login as</li>
</ol>
<p>To access the servers you will need the following</p>
<table>
<thead>
<tr>
<th style="text-align:center">Name of the host</th>
<th style="text-align:center">IP Adress</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">sshserver100</td>
<td style="text-align:center">192.168.1.100</td>
</tr>
<tr>
<td style="text-align:center">sshserver200</td>
<td style="text-align:center">192.168.1.200</td>
</tr>
</tbody>
</table>
<h3>About lack of password security</h3>
<blockquote>
<p>For the duration of this workshop, the password for all users are <code>passpass</code>. This is just to ensure that we don't waste in any time in trying to remember the passwords.</p>
</blockquote>
<h3>Important to note</h3>
<blockquote>
<p>Also if a command says <code>user</code>, you need to substitute it with your first name in lower case.</p>
</blockquote>
<h3>With the above pieces in place</h3>
<h3>SSH Login</h3>
<pre><code class="language-bash">ssh &lt;USERNAME&gt;@&lt;HOSTNAME/IP&gt;
</code></pre>
<blockquote>
<p>Try now</p>
</blockquote>
<pre><code class="language-bash">ssh user@192.168.1.100
</code></pre>
<pre><code class="language-bash">user@192.168.1.100's password:
</code></pre>
<h3>Providing a different user</h3>
<p>Try giving the username with <code>-l</code> flag</p>
<pre><code class="language-bash">ssh -l &lt;USERNAME&gt; host/ip
</code></pre>
<h3>Providing a different port</h3>
<p>What if SSH service is not listening on the standard ports?</p>
<pre><code class="language-bash">ssh -l akash -p 2222 192.168.1.200
</code></pre>
<h3>Executing the command and capturing the output</h3>
<pre><code class="language-bash">output=$(ssh akash@192.168.1.100 ls -ltra)
echo $output
</code></pre>
<h4>Try out the following commands and capture the output for both the servers</h4>
<ul>
<li><code>id</code></li>
<li><code>ifconfig</code></li>
<li><code>netstat -nltup</code></li>
<li><code>ps aux</code></li>
<li><code>iptables -L</code></li>
</ul>
<h2>Becoming Productive</h2>
<p>We realise quickly that typing the password so many times means that we can't automate and script things. And it is boring! So now we will do two things to make us really productive</p>
<ol>
<li>Use a configuration file to maintain how we want to use our SSH commands</li>
<li>Add an identity file for public/private key authentication</li>
</ol>
<h3>Using a configuration file</h3>
<p>A default configuration file can be created in <code>~/.ssh/config</code> path.</p>
<blockquote>
<p>For this workshop we will not mess with that.</p>
</blockquote>
<p>Make a new directory <code>effective-ssh-usage-for-pentesters</code> in your laptop.</p>
<pre><code class="language-bash">mkdir effective-ssh-usage-for-pentesters
cd effective-ssh-usage-for-pentesters
</code></pre>
<p>Open your favourite text editor and create a new file called <code>null-puliya-ssh-config</code></p>
<p>This is a simple text file. Configurations can be on a per-host basis.</p>
<h4>Lets add a new host</h4>
<p><code>Host server100</code></p>
<p>While it is not required, convention is to indent the various server blocks.</p>
<h4>Add a hostname or ip address for that host</h4>
<pre><code>Host server100
    Hostname 192.168.1.100
</code></pre>
<h4>Add a username</h4>
<pre><code>Host server100
    Hostname 192.168.1.100
    User user
</code></pre>
<h4>We can add two more useful configurations</h4>
<p>Primarily to ensure that our connection stays alive for long we can add the following two configuration options</p>
<ul>
<li><code>ServerAliveInterval 30</code></li>
<li><code>ServerAliveCountMax 10</code></li>
</ul>
<p>If you want to understand what these two do and also look up more options <code>man 5 ssh_config</code></p>
<h4>Final output</h4>
<pre><code>Host server100
    Hostname 192.168.1.100
    User akash
    ServerAliveInterval 30
    ServerAliveCountMax 10
</code></pre>
<h4>Using our custom config file</h4>
<pre><code class="language-bash">ssh -F null-puliya-ssh-config server100
</code></pre>
<blockquote>
<p>This is exactly where we were when we started.</p>
</blockquote>
<p>If you wanted to add the options to the original command line this is what the command would look like</p>
<pre><code class="language-bash">ssh -l user 192.168.1.100 -o ServerAliveInterval=30 -o ServerAliveCountMax=10
</code></pre>
<h4>Five minutes to go over other configuration options</h4>
<p>For SSH clients</p>
<pre><code class="language-bash">man 5 ssh_config
</code></pre>
<p>For SSH server</p>
<pre><code class="language-bash">man 5 sshd_config
</code></pre>
<h3>Using an identity file</h3>
<h4>Generating a public/private key pair</h4>
<p>Many options. For today we will do the following ones</p>
<ol>
<li>RSA</li>
<li>Twisted Edwards Curve</li>
</ol>
<blockquote>
<p>DSA is not recommended anymore. So is a RSA keysize smaller than 4096</p>
</blockquote>
<h5>RSA (Older way, but more compatible)</h5>
<pre><code class="language-bash">ssh-keygen -t rsa
</code></pre>
<blockquote>
<p>Pay attention to the output</p>
</blockquote>
<pre><code class="language-bash">Generating public/private rsa key pair.
Enter file in which to save the key (/path/to/home/dir/.ssh/id_rsa):
</code></pre>
<p>For now we don't want to save in the default place so give it a descriptive name.</p>
<p><code>server100rsa</code></p>
<pre><code class="language-bash">Enter passphrase (empty for no passphrase):
Enter same passphrase again:
</code></pre>
<blockquote>
<p>For the duration of this workshop, the phasephrases for all identities are <code>passpass</code>. This is just to ensure that we don't waste in any time in trying to remember the passwords.</p>
</blockquote>
<p>Two files will be generated.</p>
<p><code>server100rsa.pub</code> and <code>server100rsa</code></p>
<p>If you don't want the public key to leak your laptop username and hostname use this command</p>
<pre><code class="language-bash">ssh-keygen -t rsa -C &quot;null-puliya&quot;
</code></pre>
<h5>Ed25519 (What you should be using)</h5>
<pre><code class="language-bash">ssh-keygen -t ed25519 -f server100ed -Npasspass -C &quot;null-puliya-ed25519&quot;
</code></pre>
<table>
<thead>
<tr>
<th style="text-align:center">Flags</th>
<th style="text-align:left">Comment</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>-t</code></td>
<td style="text-align:left">Type of key for identity</td>
</tr>
<tr>
<td style="text-align:center"><code>-f</code></td>
<td style="text-align:left">File name of the identity key pair</td>
</tr>
<tr>
<td style="text-align:center"><code>-N</code></td>
<td style="text-align:left">Passphrase that will secure the secret key</td>
</tr>
<tr>
<td style="text-align:center"><code>-C</code></td>
<td style="text-align:left">Comment which is added to the public part of the key pair</td>
</tr>
</tbody>
</table>
<p>Two files will be generated.</p>
<p><code>server100ed.pub</code> and <code>server100ed</code></p>
<h4>How do we use this identity to login passwordlessly</h4>
<p>Two steps need to happen</p>
<table>
<thead>
<tr>
<th style="text-align:center">Step</th>
<th style="text-align:left">Remark</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:left">We need to copy the <code>public</code> key file to the server</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:left">We need to use the <code>private</code> key file when we try to login to the server, after step 1</td>
</tr>
</tbody>
</table>
<h5>Step 1</h5>
<p>See if you have the following command in your client</p>
<p><code>ssh-copy-id</code> if yes then this command</p>
<pre><code class="language-bash">ssh-copy-id -n -i server100ed.pub user@192.168.1.100
</code></pre>
<p>This is a dry run. Shows you exactly what will be copied.
If we are happy run the command without <code>-n</code>.</p>
<pre><code class="language-bash">ssh-copy-id -i server100ed.pub user@192.168.1.100
</code></pre>
<blockquote>
<p>Any one who didn't get that command? I will demonstrate the other way of copying</p>
</blockquote>
<h5>Step 2</h5>
<p>Now that we have copied our public part of the key pair successfully how do we use it?</p>
<p>In a command</p>
<pre><code class="language-bash">ssh -l akash -i server100ed 192.168.1.100
</code></pre>
<pre><code class="language-bash">Enter passphrase for key 'server100ed':
</code></pre>
<p>Logged in</p>
<p>Update <code>null-puliya-ssh-config</code> file to include two new directives</p>
<p>Host server100
Hostname 192.168.1.100
User akash
ServerAliveInterval 30
IdentityFile server100ed
IdentitiesOnly yes</p>
<p>Now lets try</p>
<pre><code class="language-bash">ssh -F null-puliya-ssh-config sshserver100
</code></pre>
<blockquote>
<p>We just traded entering our password every time with now having to enter a passphrase every time!! #@#$@#$!!!!</p>
</blockquote>
<p>Lets make sure that this time when we enter the passphrase our SSH client remembers this till we reboot the laptop. This is done using an <code>SSH agent</code></p>
<pre><code class="language-bash">ssh-add `pwd`/server100ed
</code></pre>
<p>To list all the added identities</p>
<pre><code class="language-bash">ssh-add -l
</code></pre>
<p>To delete an identity so that we get asked for the passphrase again</p>
<pre><code class="language-bash">ssh-add -d `pwd`/server100.pub
</code></pre>
<p>Try to login to the server now</p>
<pre><code class="language-bash">ssh akash@192.168.1.100
</code></pre>
<p>Or with config file</p>
<pre><code class="language-bash">ssh -F config null-puliya-ssh-config sshserver100
</code></pre>
<h2>Becoming effective</h2>
<p>Being able to use config files to login to SSH servers with the appropriate identities, per host configurations etc. is just the starting point of becoming effective.</p>
<p>The following kinds of activities become simple once you have the basics in place</p>
<ol>
<li>Secure copy of files and folders to and from servers</li>
<li>Using one server as a jump box to another server</li>
<li>Using a server as a SOCKS proxy to send all data through it</li>
</ol>
<h3>Secure copying of files</h3>
<p>Let us copy a folder from the server</p>
<pre><code class="language-bash">scp -F null-puliya-ssh-config -r sshserver100:/usr/local/share/wordpress-files wordpress-files
</code></pre>
<pre><code class="language-bash">scp &lt;SSH-RELATED-CONFIG&gt; -r &lt;SOURCE&gt; &lt;DESTINATION&gt;
</code></pre>
<p>We can always have source as local and destination on the server. We just need to ensure that we have adequate permission to write to the path we want to write to</p>
<p>Lets copy the <code>wordpress-files</code> to our home directory on the server</p>
<pre><code class="language-bash">scp -F null-puliya-ssh-config -r wordpress-files sshserver100:.
</code></pre>
<p>Here <code>sshserver100:.</code> translates into user@HOST and the <code>.</code> after the colon translates into current directory.</p>
<blockquote>
<p>If you are confused, ask yourself this question. What is the directory I am in when I have just logged in to the server</p>
</blockquote>
<h3>Using a computer as a jumpbox</h3>
<pre><code class="language-bash">ssh -t -F null-puliya-ssh-config -A sshserver100 ssh 192.168.1.200 -p 2222
</code></pre>
<p>Using the configuration file</p>
<pre><code>Host sshserver100
    Hostname 192.168.1.100
    User akash
    ServerAliveInterval 30
    ServerAliveCountMax 10
    IdentityFile server100ed
    IdentitiesOnly yes
Host sshserver200
    Hostname 192.168.1.200
    #ProxyJump ssh akash@192.168.1.100:22
    ProxyCommand ssh -W %h:%p akash@192.168.1.100
    User akash
    Port 2222
    ServerAliveInterval 30
    ServerAliveCountMax 10
</code></pre>
<p>Now we can simply run this command</p>
<pre><code class="language-bash">ssh -F null-puliya-ssh-config sshserver200
</code></pre>
<p>Did you notice we are being asked for the password for the second server. Remember <code>ssh-copy-id</code></p>
<pre><code class="language-bash">ssh-copy-id -i server100ed.pub akash@192.168.1.200 -p 2222
</code></pre>
<p>Now try again</p>
<pre><code class="language-bash">ssh -F null-puliya-ssh-config sshserver200
</code></pre>
<h2>References</h2>
<h3>Proxies and Jump Hosts</h3>
<p>A great reference for this topic is <a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Proxies_and_Jump_Hosts">OpenSSH Cookbook - Proxies and Jump Hosts</a></p>
<h3>Capturing Output and Input</h3>
<p><a href="https://en.wikibooks.org/wiki/OpenSSH/Cookbook/Remote_Processes">OpenSSH Cookbook - Remote Processes</a></p>
<h3>Misc</h3>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Twisted_Edwards_curve">https://en.wikipedia.org/wiki/Twisted_Edwards_curve</a></li>
<li><a href="https://medium.com/risan/upgrade-your-ssh-key-to-ed25519-c6e8d60d3c54">Upgrade your SSH key to ed25519</a></li>
<li><a href="https://www.exoscale.com/syslog/advanced-ssh-6-things/">Advanced SSH 6 Things</a></li>
<li><a href="http://jonisalonen.com/2010/5-cool-things-you-can-do-with-ssh-besides-logging-in/">5 cool things you can do with SSH besides logging in</a></li>
<li><a href="https://medium.com/@shazow/ssh-how-does-it-even-9e43586e4ffc">A secure chat system using just SSH</a></li>
</ul>
